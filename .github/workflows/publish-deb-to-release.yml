name: Build DEB (salt python runtime)

on:
  push:
    tags:
      - "v*"

jobs:
  build-deb:
    runs-on: ubuntu-22.04

    permissions:
      contents: write

    env:
      PKG: salt-bundle
      INSTALL_ROOT: /opt/saltstack/salt-bundle

    steps:
      - uses: actions/checkout@v4

      - name: Version from tag
        run: |
          echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_ENV

      - name: Build deps
        run: |
          sudo apt-get update
          sudo apt-get install -y python3 python3-pip ruby ruby-dev build-essential

      - name: Install fpm
        run: sudo gem install --no-document fpm

      - name: Build wheel
        run: |
          python3 -m pip install --upgrade pip build
          python3 -m build --wheel

      - name: Vendor ONLY non-salt deps
        run: |
          mkdir vendor
          pip install --target vendor \
            "pydantic>=2" \
            "semver>=3" \
            "click>=8"

      - name: Extract package to lib/
        run: |
          mkdir -p lib
          unzip -q dist/*.whl -d lib/

      - name: Prepare dist-info for Salt site-packages
        run: |
          mkdir -p site-packages
          # Copy ONLY .dist-info to Salt's site-packages for entry_points discovery
          # This allows importlib.metadata to find our entry_points while keeping
          # the actual code isolated in /opt/saltstack/salt-bundle/lib
          cp -r lib/salt_bundle-*.dist-info site-packages/

      - name: salt-bundle entrypoint (salt python)
        run: |
          mkdir -p bin
          cat > bin/salt-bundle <<'OUTER_EOF'
          #!/bin/sh
          set -e

          if [ -x /opt/saltstack/salt/bin/python3 ]; then
            PYTHON=/opt/saltstack/salt/bin/python3
          elif [ -x /usr/bin/python3 ]; then
            PYTHON=/usr/bin/python3
          else
            echo "ERROR: Salt python not found" >&2
            exit 1
          fi

          export PYTHONPATH="/opt/saltstack/salt-bundle/lib:/opt/saltstack/salt-bundle/vendor:${PYTHONPATH}"
          exec "$PYTHON" -m salt_bundle "$@"
          OUTER_EOF
          chmod +x bin/salt-bundle

      - name: Create pth file for Salt loader
        run: |
          mkdir -p pth
          echo "/opt/saltstack/salt-bundle/lib" > pth/salt-bundle.pth
          echo "/opt/saltstack/salt-bundle/vendor" >> pth/salt-bundle.pth

      - name: Create symlink for /usr/bin
        run: |
          mkdir -p usr-bin
          ln -s /opt/saltstack/bin/salt-bundle usr-bin/salt-bundle

      - name: Build deb
        run: |
          fpm -s dir -t deb \
            -n "${PKG}" \
            -v "${VERSION}" \
            -a amd64 \
            --depends salt-common \
            --prefix / \
            vendor/=/opt/saltstack/salt-bundle/vendor \
            lib/=/opt/saltstack/salt-bundle/lib \
            bin/salt-bundle=/opt/saltstack/bin/salt-bundle \
            usr-bin/salt-bundle=/usr/bin/salt-bundle \
            pth/salt-bundle.pth=/opt/saltstack/salt/lib/python3.10/site-packages/salt-bundle.pth \
            site-packages/=/opt/saltstack/salt/lib/python3.10/site-packages/

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          path: "*.deb"

      - name: Upload assets to existing release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG_NAME: ${{ github.ref_name }}
        run: |
          gh release view "$TAG_NAME" --repo "$GITHUB_REPOSITORY" >/dev/null
          gh release upload "$TAG_NAME" *.deb --repo "$GITHUB_REPOSITORY" --clobber
